name: Update repository

# Controls when the workflow will run
on:
  schedule:
    - cron: '50 6 * * *'
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build-debian:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Github Actions user in Git
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Make sure './update_repository.sh' is executable
        run: chmod +x update_repository.sh
        
      - name: Update debian subtree
        run: ./update_repository.sh debian
 
  build-dependents:
    name: build ${{ matrix.subtree }}
    # will wait for build-debian job to complete
    needs: build-debian
    strategy:
      matrix:
        subtree: [python]
    
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Set up Github Actions user in Git
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com
      
      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Make sure './update_repository.sh' is executable
        run: chmod +x update_repository.sh
        
      - name: Update ${{ matrix.subtree }} subtree
        run: ./update_repository.sh ${{ matrix.subtree }}